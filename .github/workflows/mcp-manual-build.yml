name: MCP Manual Build APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'é€‰æ‹©æž„å»ºç±»åž‹'
        required: true
        default: 'both'
        type: choice
        options:
        - debug
        - release
        - both
      create_release:
        description: 'æ˜¯å¦åˆ›å»ºGitHub Release'
        required: false
        default: true
        type: boolean
      release_tag:
        description: 'è‡ªå®šä¹‰Releaseæ ‡ç­¾ (ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ)'
        required: false
        type: string
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜Ž'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘çš„APKæž„å»º'
        type: string

env:
  JAVA_VERSION: '11'
  ANDROID_API_LEVEL: '34'
  BUILD_TOOLS_VERSION: '34.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      debug_apk: ${{ steps.build_info.outputs.debug_apk }}
      release_apk: ${{ steps.build_info.outputs.release_apk }}
      
    steps:
    - name: ðŸ“ Checkout repository
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ðŸ“± Set up Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: ${{ env.ANDROID_API_LEVEL }}
        build-tools: ${{ env.BUILD_TOOLS_VERSION }}
        
    - name: ðŸ’¾ Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ðŸ”§ Grant execute permission for gradlew
      run: chmod +x android/gradlew
      
    - name: ðŸ“‹ Display build configuration
      run: |
        echo "ðŸ—ï¸ æž„å»ºé…ç½®ä¿¡æ¯:"
        echo "- æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type }}"
        echo "- åˆ›å»ºRelease: ${{ github.event.inputs.create_release }}"
        echo "- Releaseæ ‡ç­¾: ${{ github.event.inputs.release_tag || 'è‡ªåŠ¨ç”Ÿæˆ' }}"
        echo "- Javaç‰ˆæœ¬: ${{ env.JAVA_VERSION }}"
        echo "- Android API: ${{ env.ANDROID_API_LEVEL }}"
        
    - name: ðŸ› Build Debug APK
      if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'both'
      run: |
        echo "ðŸ”¨ æž„å»ºDebug APK..."
        cd android
        ./gradlew clean assembleDebug --stacktrace
        
    - name: ðŸš€ Build Release APK
      if: github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both'
      run: |
        echo "ðŸ”¨ æž„å»ºRelease APK..."
        cd android
        ./gradlew assembleRelease --stacktrace
        
    - name: ðŸ“Š Set build info
      id: build_info
      run: |
        DEBUG_APK=""
        RELEASE_APK=""
        
        if [ "${{ github.event.inputs.build_type }}" == "debug" ] || [ "${{ github.event.inputs.build_type }}" == "both" ]; then
          if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            DEBUG_APK="android/app/build/outputs/apk/debug/app-debug.apk"
            echo "âœ… Debug APKæž„å»ºæˆåŠŸ"
          else
            echo "âŒ Debug APKæž„å»ºå¤±è´¥"
          fi
        fi
        
        if [ "${{ github.event.inputs.build_type }}" == "release" ] || [ "${{ github.event.inputs.build_type }}" == "both" ]; then
          if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
            RELEASE_APK="android/app/build/outputs/apk/release/app-release.apk"
            echo "âœ… Release APKæž„å»ºæˆåŠŸ"
          else
            echo "âŒ Release APKæž„å»ºå¤±è´¥"
          fi
        fi
        
        echo "debug_apk=$DEBUG_APK" >> $GITHUB_OUTPUT
        echo "release_apk=$RELEASE_APK" >> $GITHUB_OUTPUT
        
    - name: ðŸ“¦ Upload Debug APK
      if: steps.build_info.outputs.debug_apk != ''
      uses: actions/upload-artifact@v3
      with:
        name: nebula-debug-apk-${{ github.run_number }}
        path: ${{ steps.build_info.outputs.debug_apk }}
        retention-days: 30
        
    - name: ðŸ“¦ Upload Release APK
      if: steps.build_info.outputs.release_apk != ''
      uses: actions/upload-artifact@v3
      with:
        name: nebula-release-apk-${{ github.run_number }}
        path: ${{ steps.build_info.outputs.release_apk }}
        retention-days: 30
        
    - name: ðŸ“‹ Copy APKs to root directory
      run: |
        mkdir -p release_files
        if [ -n "${{ steps.build_info.outputs.debug_apk }}" ]; then
          cp ${{ steps.build_info.outputs.debug_apk }} ./nebula-debug-${{ github.run_number }}.apk
          cp ${{ steps.build_info.outputs.debug_apk }} ./release_files/
        fi
        if [ -n "${{ steps.build_info.outputs.release_apk }}" ]; then
          cp ${{ steps.build_info.outputs.release_apk }} ./nebula-release-${{ github.run_number }}.apk
          cp ${{ steps.build_info.outputs.release_apk }} ./release_files/
        fi
        
  create_release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.create_release == 'true' && (needs.build.outputs.debug_apk != '' || needs.build.outputs.release_apk != '')
    
    steps:
    - name: ðŸ“ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download artifacts
      uses: actions/download-artifact@v3
      
    - name: ðŸ“‹ Prepare release assets
      id: prepare_assets
      run: |
        mkdir -p release_assets
        ASSET_LIST=""
        
        if [ -d "nebula-debug-apk-${{ github.run_number }}" ]; then
          cp nebula-debug-apk-${{ github.run_number }}/* release_assets/
          mv release_assets/app-debug.apk release_assets/nebula-debug-${{ github.run_number }}.apk
          ASSET_LIST="$ASSET_LIST
          release_assets/nebula-debug-${{ github.run_number }}.apk"
          echo "âœ… Debug APKå·²å‡†å¤‡"
        fi
        
        if [ -d "nebula-release-apk-${{ github.run_number }}" ]; then
          cp nebula-release-apk-${{ github.run_number }}/* release_assets/
          mv release_assets/app-release.apk release_assets/nebula-release-${{ github.run_number }}.apk
          ASSET_LIST="$ASSET_LIST
          release_assets/nebula-release-${{ github.run_number }}.apk"
          echo "âœ… Release APKå·²å‡†å¤‡"
        fi
        
        echo "asset_list=$ASSET_LIST" >> $GITHUB_OUTPUT
        
    - name: ðŸ·ï¸ Generate release tag
      id: tag
      run: |
        if [ -n "${{ github.event.inputs.release_tag }}" ]; then
          echo "tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag=v${{ github.run_number }}-$(date +%Y%m%d-%H%M)" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸš€ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "Nebula APK Release ${{ steps.tag.outputs.tag }}"
        body: |
          ## ðŸ“± ${{ github.event.inputs.release_notes }}
          
          ### ðŸ“¦ æž„å»ºä¿¡æ¯
          - **æž„å»ºç±»åž‹**: ${{ github.event.inputs.build_type }}
          - **æž„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}
          - **Commit**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          - **æž„å»ºå·**: ${{ github.run_number }}
          
          ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
          ${{ needs.build.outputs.debug_apk != '' && '- **Debug APK**: ç”¨äºŽå¼€å‘æµ‹è¯•ï¼ŒåŒ…å«è°ƒè¯•ä¿¡æ¯' || '' }}
          ${{ needs.build.outputs.release_apk != '' && '- **Release APK**: ç”Ÿäº§ç‰ˆæœ¬ï¼ˆæœªç­¾åï¼‰ï¼Œéœ€è¦ç­¾ååŽå®‰è£…' || '' }}
          
          ### ðŸ› ï¸ å®‰è£…è¯´æ˜Ž
          1. ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå…è®¸"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
          3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          
          > **æ³¨æ„**: Releaseç‰ˆæœ¬éœ€è¦ç­¾ååŽæ‰èƒ½æ­£å¸¸å®‰è£…ä½¿ç”¨
        files: ${{ steps.prepare_assets.outputs.asset_list }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BUILD_TIME: ${{ env.BUILD_TIME }}
        
  notify:
    needs: [build, create_release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“¢ Build Summary
      run: |
        echo "## ðŸ—ï¸ æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| æž„å»ºç±»åž‹ | ${{ github.event.inputs.build_type }} |" >> $GITHUB_STEP_SUMMARY
        echo "| æž„å»ºçŠ¶æ€ | ${{ needs.build.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Releaseåˆ›å»º | ${{ needs.create_release.result == 'success' && 'âœ… æˆåŠŸ' || (github.event.inputs.create_release == 'true' && 'âŒ å¤±è´¥' || 'â­ï¸ è·³è¿‡') }} |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build.outputs.debug_apk }}" != "" ]; then
          echo "| Debug APK | âœ… å·²æž„å»º |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.build.outputs.release_apk }}" != "" ]; then
          echo "| Release APK | âœ… å·²æž„å»º |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- å‰å¾€ [Actions Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ä¸‹è½½APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.create_release }}" == "true" ] && [ "${{ needs.create_release.result }}" == "success" ]; then
          echo "- å‰å¾€ [Releases](https://github.com/${{ github.repository }}/releases) æŸ¥çœ‹æœ€æ–°å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
        fi